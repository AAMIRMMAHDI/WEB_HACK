<!DOCTYPE html>
<html lang="fa" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMD کلاینت {{ client.client_id }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; background: #000; color: #00ff00; }
        .container { max-width: 90vw; margin: 0 auto; padding: 20px; }
        #terminal {
            background: #000;
            border: 2px solid #333;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #prompt { display: flex; align-items: center; margin-top: 10px; }
        #command-input {
            background: transparent;
            color: #00ff00;
            border: none;
            outline: none;
            flex-grow: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }
        .command-line { color: #00ff00; }
        .output-line { color: white; }
        .error-line { color: red; }
        #terminal::-webkit-scrollbar { width: 5px; }
        #terminal::-webkit-scrollbar-track { background: #222; }
        #terminal::-webkit-scrollbar-thumb { background: #555; }
    </style>
</head>
<body>
    <div class="container">
        {% if error %}
            <h1 class="text-2xl font-bold text-red-500">{{ error }}</h1>
        {% else %}
            <h1 class="text-xl font-bold mb-4">CMD کلاینت: {{ client.client_id }}</h1>
            <div id="terminal">
                <div id="history"></div>
                <div id="prompt">
                    <span>> </span>
                    <input id="command-input" type="text" autofocus>
                </div>
            </div>
        {% endif %}
        <a href="{% url 'index' %}" class="text-blue-500 hover:underline mt-4 inline-block">بازگشت به لیست کلاینت‌ها</a>
    </div>
    {% if not error %}
    <script>
        const clientId = "{{ client.client_id }}";
        const csrfToken = "{{ csrf_token }}";
        const historyDiv = document.getElementById('history');
        const commandInput = document.getElementById('command-input');
        let lastOutputHash = null;

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return hash;
        }

        function addToHistory(text, className) {
            const line = document.createElement('div');
            line.className = className;
            line.textContent = text;
            historyDiv.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
            console.log(`Added to history: ${className}: ${text.slice(0, 100)}`);
        }

        function sendCommand() {
            const command = commandInput.value.trim();
            if (!command) return;
            addToHistory(`> ${command}`, 'command-line');
            commandInput.value = '';
            fetch(`/api/command/${clientId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ command })
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('Command sent:', data);
                commandInput.focus();
            })
            .catch(error => {
                console.error('Error sending command:', error);
                addToHistory(`خطا در ارسال دستور: ${error.message}`, 'error-line');
            });
        }

        function updateOutput() {
            fetch(`/api/poll/${clientId}/`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('Poll response:', data);
                const output = data.last_output || '';
                const outputHash = hashString(output);
                if (output && outputHash !== lastOutputHash) {
                    addToHistory(output, 'output-line');
                    lastOutputHash = outputHash;
                    console.log('New output displayed:', output.slice(0, 100));
                }
            })
            .catch(error => {
                console.error('Error polling output:', error);
                addToHistory(`خطا در دریافت خروجی: ${error.message}`, 'error-line');
            });
        }

        commandInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendCommand();
        });

        commandInput.focus();

        setInterval(updateOutput, 1000);
        updateOutput();
        console.log('Terminal initialized for client:', clientId);
    </script>
    {% endif %}
</body>
</html>
